# 性能优化执行篇

## 一、引言

对于渲染层面，亦即执行层面的性能优化，又可以分为以下四个部分来讨论。

* 执行优化
* 渲染优化
* 样式优化
* 脚本优化

## **二、执行优化**

### **1**. 图片优化

* 不用图片。很多时候会使用到很多修饰类图片，其实这类修饰图片完全可以用 CSS 去代替。
* 对于移动端来说，屏幕宽度就那么点，完全没有必要去加载原图浪费带宽。一般图片都用 CDN 加载，可以计算出适配屏幕的宽度，然后去请求相应裁剪好的图片。
* 小图使用 base64 格式
* 将多个图标文件整合到一张图片中（雪碧图）
* 选择正确的图片格式：
  * 对于能够显示 WebP 格式的浏览器尽量使用 WebP 格式。因为 WebP 格式具有更好的图像数据压缩算法，能带来更小的图片体积，而且拥有肉眼识别无差异的图像质量，缺点就是兼容性并不好
  * 小图使用 PNG，其实对于大部分图标这类图片，完全可以使用 SVG 代替
  * 照片使用 JPEG

### 2. 无阻塞加载

无阻塞加载即将 CSS 放在文件头部，JavaScript 文件放在底部。

* CSS 执行会阻塞渲染，阻止 JS 执行；
* JS 加载和执行会阻塞 HTML 解析，阻止 CSSOM 构建；

如果这些 CSS、JS 标签放在 HEAD 标签里，并且需要加载和解析很久的话，那么页面就空白了。所以 JS 文件要放在底部（不阻止 DOM 解析，但会阻塞渲染），等 HTML 解析完了再加载 JS 文件，尽早向用户呈现页面的内容。

那为什么 CSS 文件还要放在头部呢？

因为先加载 HTML 再加载 CSS，会让用户第一时间看到的页面是没有样式的、“丑陋”的，为了避免这种情况发生，就要将 CSS 文件放在头部了。

### **3. 避免资源标签 src 为空**

避免img、iframe等的src为空，空`src`会重新加载当前页面，影响速度和效率

## **三、渲染优化**

*   **设置viewport**：HTML的`viewport`可加速页面的渲染

    ```html
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, minimum-scale=1, maximum-scale=1">
    复制代码
    ```
* **减少DOM节点**：DOM节点太多影响页面的渲染，尽量减少DOM节点
* **优化动画**
  * 尽量使用CSS3动画
  * 合理使用requestAnimationFrame动画代替setTimeout
  * 适当使用Canvas动画：5个元素以内使用`CSS动画`，5个元素以上使用`Canvas动画`，`iOS8+`可使用`WebGL动画`
* **优化高频事件**：`scroll`、`touchmove`等事件可导致多次渲染
  * 函数节流
  * 函数防抖
  * 使用requestAnimationFrame监听帧变化：使得在正确的时间进行渲染
  * 增加响应变化的时间间隔：减少重绘次数
* **GPU加速**：使用某些HTML5标签和CSS3属性会触发`GPU渲染`，请合理使用(**过渡使用会引发手机耗电量增加**)
  * HTML标签：`video`、`canvas`、`webgl`
  * CSS属性：`opacity`、`transform`、`transition`

## **四、样式优化**

* **避免在HTML中书写style**
* **避免CSS表达式**：CSS表达式的执行需跳出CSS树的渲染
* **移除CSS空规则**：CSS空规则增加了css文件的大小，影响CSS树的执行
* **正确使用display**：`display`会影响页面的渲染
  * `display:inline`后不应该再使用`float`、`margin`、`padding`、`width`和`height`
  * `display:inline-block`后不应该再使用`float`
  * `display:block`后不应该再使用`vertical-align`
  * `display:table-*`后不应该再使用`float`和`margin`
* **不滥用float**：`float`在渲染时计算量比较大，尽量减少使用
* **不滥用Web字体**：Web字体需要下载、解析、重绘当前页面，尽量减少使用
* **不声明过多的font-size**：过多的`font-size`影响CSS树的效率
* **值为0时不需要任何单位**：为了浏览器的兼容性和性能，值为`0`时不要带单位
* **标准化各种浏览器前缀**
  * 无前缀属性应放在最后
  * CSS动画属性只用-webkit-、无前缀两种
  * 其它前缀为-webkit-、-moz-、-ms-、无前缀四种：`Opera`改用`blink`内核，`-o-`已淘汰
* **避免让选择符看起来像正则表达式**：高级选择符执行耗时长且不易读懂，避免使用

## **五、脚本优化**

* **减少重绘和回流**
  * 避免不必要的DOM操作
  * 避免使用document.write
  * 减少drawImage
  * 尽量改变class而不是style，使用classList代替className
* **缓存DOM选择与计算**：每次DOM选择都要计算和缓存
* **缓存.length的值**：每次`.length`计算用一个变量保存值
* **尽量使用事件代理**：避免批量绑定事件
* **尽量使用id选择器**：`id`选择器选择元素是最快的
* **touch事件优化**：使用`tap`(`touchstart`和`touchend`)代替`click`(**注意`touch`响应过快，易引发误操作**)







### 节流和防抖

* 函数防抖是指在事件被触发 n 秒后再执行回调，如果在这 n 秒内事件又被触发，则重新计时。这可以使用在一些点击请求的事件上，避免因为用户的多次点击向后端发送多次请求。
* 函数节流是指规定一个单位时间，在这个单位时间内，只能有一次触发事件的回调函数执行，如果在同一个单位时间内某事件被触发多次，只有一次能生效。节流可以使用在 scroll 函数的事件监听上，通过事件节流来降低事件调用的频率。

**防抖函数的应用场景：**

* 按钮提交场景：防⽌多次提交按钮，只执⾏最后提交的⼀次
* 服务端验证场景：表单验证需要服务端配合，只执⾏⼀段连续的输⼊事件的最后⼀次，还有搜索联想词功能类似⽣存环境请⽤lodash.debounce

**节流函数的适⽤场景：**

* 拖拽场景：固定时间内只执⾏⼀次，防⽌超⾼频次触发位置变动
* 缩放场景：监控浏览器resize
* 动画场景：避免短时间内多次触发动画引起性能问题

## 六、参考

* [前端性能优化指南](https://juejin.cn/post/6844903844455907336)
* [前端性能优化 24 条建议](https://juejin.cn/post/6892994632968306702)
* [写给中高级前端的性能优化](https://juejin.cn/post/6981673766178783262)
* [工作中如何进行前端性能优化](https://juejin.cn/post/6904517485349830670)
* [写在 2021 的前端性能优化指南](https://juejin.cn/post/7020212914020302856)
* [前端性能优化之雅虎 35 条军规](https://juejin.cn/post/6844903657318645767)
* [高频前端面试题汇总之前端性能优化篇](https://juejin.cn/post/6941278592215515143)
* [前端性能优化三部曲(加载篇)](https://juejin.cn/post/6844903863963631623)
