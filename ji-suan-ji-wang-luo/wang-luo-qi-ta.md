# 网络其它

## 一、网络层

### 1. 网络层功能

网络层主要任务是将分组从一台主机移动到另一台主机，从而提供了主机到主机的通信服务和各种形式的进程到进程的通信。采用储存转发方式，数据交换单位是报文。

> 大多数计算机网络都不能连续地传送任意长的数据，所以实际上网络系统会把数据分割成小块，然后逐块地发动，这种小块就称作**分组**。

网络层中涉及众多的协议，其中包括最重要的协议，也是TCP/IP的核心协议——IP协议。IP协议非常简单，仅仅提供不可靠、无连接的传送服务。IP协议的主要功能有：无连接数据报传输、数据报路由选择和差错控制。

与 IP 协议配套使用实现其功能的还有地址解析协议 ARP、逆地址解析协议 RARP、因特网报文协议ICMP、因特网组管理协议 IGMP。

![网络层](<../.gitbook/assets/image (7).png>)

### 2. IP 协议

IP 协议（Internet Protocol）又称互联网协议，是支持网间互联的数据包协议。该协议工作在网络层，主要目的就是为了提高网络的可扩展性，和传输层 TCP 相比，IP 协议提供一种无连接/不可靠、尽力而为的数据包传输服务，其与TCP协议（传输控制协议）一起构成了TCP/IP 协议族的核心。IP 协议主要有以下几个作用：

#### 寻址和路由

在IP 数据包中会携带源 IP 地址和目的 IP 地址来标识该数据包的源主机和目的主机。IP 数据报在传输过程中，每个中间节点（IP 网关、路由器）只根据网络地址进行转发，如果中间节点是路由器，则路由器会根据路由表选择合适的路径。IP 协议根据路由选择协议提供的路由信息对 IP 数据报进行转发，直至抵达目的主机。&#x20;

#### 分段与重组

IP 数据包在传输过程中可能会经过不同的网络，在不同的网络中数据包的最大长度限制是不同的，IP 协议通过给每个 IP 数据包分配一个标识符以及分段与组装的相关信息，使得数据包在不同的网络中能够传输，被分段后的 IP 数据报可以独立地在网络中进行转发，在到达目的主机后由目的主机完成重组工作，恢复出原来的 IP 数据包。

\


![IP 协议中的数据包转发流程](<../.gitbook/assets/image (5).png>)

### 3. IP 地址

通常 IP 地址可以分为以下几类：

![IP 地址](<../.gitbook/assets/image (6).png>)

* A类：`1.0.0.0~126.255.255.255`
* B类：`128.0.0.0~191.255.255.255`
* C类：`192.0.0.0~223.255.255.255`
* D类：`224.0.0.0~239.255.255.255`
* E类：`240.0.0.0~254.255.255.255`
* 其中`127.0.0.0~127.255.255.255`用于环回测试，D类地址用于组播，E类地址用于科研

还有有一部分**私有 IP 地址**，是不能拿到网络上跟别的计算机通信的。只能是局域网内部用：

\


![私有 IP 地址](<../.gitbook/assets/image (10).png>)

### 4. NAT

NAT（Network Address Translation），即网络地址转换，它是一种把内部私有网络地址翻译成公有网络 IP 地址的技术。该技术不仅能解决 IP 地址不足的问题，而且还能隐藏和保护网络内部主机，从而避免来自外部网络的攻击。

NAT 的实现方式主要有三种：

#### 静态转换

内部私有 IP 地址和公有 IP 地址是一对一的关系，并且不会发生改变。通过静态转换，可以实现外部网络对内部网络特定设备的访问，这种方式原理简单，但当某一共有 IP 地址被占用时，跟这个 IP 绑定的内部主机将无法访问 Internet。&#x20;

#### 动态转换

采用动态转换的方式时，私有 IP 地址每次转化成的公有 IP 地址是不唯一的。当私有 IP 地址被授权访问 Internet 时会被随机转换成一个合法的公有 IP 地址。当 ISP 通过的合法 IP 地址数量略少于网络内部计算机数量时，可以采用这种方式。&#x20;

#### 端口多路复用

该方式将外出数据包的源端口进行端口转换，通过端口多路复用的方式，实现内部网络所有主机共享一个合法的外部 IP 地址进行 Internet 访问，从而最大限度地节约 IP 地址资源。同时，该方案可以隐藏内部网络中的主机，从而有效避免来自 Internet 的攻击。

### 5. ARP 协议

ARP（Address Resolution Protocol）是地址解析协议的缩写，该协议提供根据 IP 地址获取物理地址的功能，它工作在第二层，是一个数据链路层协议，其在本层和物理层进行联系，同时向上层提供服务。当通过以太网发送 IP 数据包时，需要先封装 32 位的 IP 地址和 48位 MAC 地址。在局域网中两台主机进行通信时需要依靠各自的物理地址进行标识，但由于发送方只知道目标 IP 地址，不知道其 MAC 地址，因此需要使用地址解析协议。&#x20;

ARP 协议的解析过程如下：

* 首先，每个主机都会在自己的 ARP 缓冲区中建立一个 ARP 列表，以表示 IP 地址和 MAC 地址之间的对应关系；
* 当源主机要发送数据时，首先检查 ARP 列表中是否有 IP 地址对应的目的主机 MAC 地址，如果存在，则可以直接发送数据，否则就向同一子网的所有主机发送 ARP 数据包。该数据包包括的内容有源主机的 IP 地址和 MAC 地址，以及目的主机的 IP 地址。
* 当本网络中的所有主机收到该 ARP 数据包时，首先检查数据包中的 目的 主机IP 地址是否是自己的 IP 地址，如果不是，则忽略该数据包，如果是，则首先从数据包中取出源主机的 IP 和 MAC 地址写入到 ARP 列表中，如果已经存在，则覆盖，然后将自己的 MAC 地址写入 ARP 响应包中，告诉源主机自己是它想要找的 MAC 地址。
* 源主机收到 ARP 响应包后。将目的主机的 IP 和 MAC 地址写入 ARP 列表，并利用此信息发送数据。如果源主机一直没有收到 ARP 响应数据包，表示 ARP 查询失败。

> RARP（Reverse Address Resolution Protocol）协议指逆地址解析协议，可以把数据链路层 MAC 48位地址转化为网络层32位地址。

### 6. ICMP 协议

ICMP（Internet Control Message Protocol）是因特网控制报文协议，主要是实现 IP 协议中未实现的部分功能，是一种网络层协议。该协议并不传输数据，只传输控制信息来辅助网络层通信。其主要的功能是验证网络是否畅通（确认接收方是否成功接收到 IP 数据包）以及辅助 IP 协议实现可靠传输（若发生 IP 丢包，ICMP 会通知发送方 IP 数据包被丢弃的原因，之后发送方会进行相应的处理）。

ICMP 协议在实际中的应用：

#### Ping

Ping（Packet Internet Groper），即因特网包探测器，是一种工作在网络层的服务命令，主要用于测试网络连接量。本地主机通过向目的主机发送 ICMP Echo 请求报文，目的主机收到之后会发送 Echo 响应报文，Ping 会根据时间和成功响应的次数估算出数据包往返时间以及丢包率从而推断网络是否通畅、运行是否正常等。

#### TraceRoute

TraceRoute 是 ICMP 的另一个应用，其主要用来跟踪一个分组从源点耗费最少 TTL 到达目的地的路径。TraceRoute 通过逐渐增大 TTL 值并重复发送数据报来实现其功能，首先，TraceRoute 会发送一个 TTL 为 1 的 IP 数据报到目的地，当路径上的第一个路由器收到这个数据报时，它将 TTL 的值减 1，此时 TTL = 0，所以路由器会将这个数据报丢掉，并返回一个差错报告报文，之后源主机会接着发送一个 TTL 为 2 的数据报，并重复此过程，直到数据报能够刚好到达目的主机。此时 TTL = 0，因此目的主机要向源主机发送 ICMP 终点不可达差错报告报文，之后源主机便知道了到达目的主机所经过的路由器 IP 地址以及到达每个路由器的往返时间。

> TTL 是指生存时间，简单来说，它表示了数据包在网络中的时间。每经过一个路由器后 TTL 就减一，这样 TTL 最终会减为 0 ，当 TTL 为 0 时，则将数据包丢弃。通过设置 TTL 可以避免这两个路由器之间形成环导致数据包在环路上死转的情况，由于有了 TTL ，当 TTL 为 0 时，数据包就会被抛弃。

### 7. 路由器转发流程

在路由器中转发数据包的流程如下：

1. 从 IP 数据包中提取出目的主机的 IP 地址，找到其所在的网络；
2. 判断目的 IP 地址所在的网络是否与本路由器直接相连，如果是，则不需要经过其它路由器直接交付，否则执行 ③；
3. 检查路由表中是否有目的 IP 地址的特定主机路由。如果有，则按照路由表传送到下一跳路由器中，否则执行 ④；
4. 逐条检查路由表，使用每一行的子网掩码与目的IP匹配。若找到匹配路由，则按照路由表转发到下一跳路由器中，否则执行步骤 ⑤；
5. 若路由表中设置有默认路由，则按照默认路由转发到默认路由器中，否则执行步骤 ⑥；
6. 无法找到合适路由，向源主机报错。

## 二、数据链路层

### 1. 数据链路层功能

数据链路层在物理层提供的服务的基础上向网络层提供服务，其最基本的服务是将源自网络层来的数据可靠地传输到相邻节点的目标机网络层。数据链路层在不可靠的物理介质上提供可靠的传输。

#### 封装成帧

将网络层传下来的分组前后分别添加首部和尾部，这样就构成了帧。首部和尾部的一个重要作用是帧定界，也携带了一些必要的控制信息，对于每种数据链路层协议都规定了帧的数据部分的最大长度。&#x20;

#### 透明传输

帧使用首部和尾部进行定界，如果帧的数据部分含有和首部和尾部相同的内容， 那么帧的开始和结束的位置就会判断错，因此需要在数据部分中出现有歧义的内容前边插入转义字符，如果数据部分出现转义字符，则在该转义字符前再加一个转义字符。在接收端进行处理之后可以还原出原始数据。这个过程透明传输的内容是转义字符，用户察觉不到转义字符的存在。&#x20;

#### 差错检测

目前数据链路层广泛使用循环冗余检验（CRC）来检查数据传输过程中是否产生比特差错。

### 2. 数据链路层设备

#### 网桥

根据 MAC 帧的目的地址进行转发和过滤。当网桥收到一个帧时，并不会向所有接口转发此帧，而是先检查此帧的目的 MAC`地址`，然后再确定将该帧转发到哪一个口，或者是把它丢弃。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c1d1ce4ecdee47689b52709bc49d57af\~tplv-k3u1fbpfcp-watermark.awebp)

> 网桥连接的是不同的网段，同一网段指的是`IP地址`和`子网掩码`相与得到相同的网络地址。

#### 以太网交换机

谈到交换机，就不得不提两个概念，冲突域和广播域

* 冲突域： 是指同一时间只能由一台设备发送信息的范围。
* 广播域：如果站点发出一个广播信号，所有能接收到这个信号的设备范围称为广播域
* 也就是说，广播域可以跨网段，而冲突域只是发生的同一个网段。

### 3. 以太网协议

以太网协议是一种使用广泛的局域网技术，是一种应用于数据链路层的协议，使用以太网可以完成相邻设备的数据帧传输。

#### 以太网帧格式

![以太网帧](<../.gitbook/assets/image (12).png>)

* 其中目的地址和源地址指的是 MAC 地址，即设备的物理地址。MAC地址用于标示网卡，每个网卡都具有唯一的 MAC 地址；
* 当在同一个局域网中，主机A需要给主机B发送消息时，主机A将以太网帧发出，此时局域网中所有主机均可收到这个帧，主机中的网卡接收到以太网帧后，会将目的 MAC 地址和自己的 MAC 地址进行比较,如果不相同就会丢弃，如果相同则会接收，此时则Ｂ主机就收到了Ａ 的消息；
* 其最后面是 CRC 循环冗余码，用于差错控制，即检验帧的正确性；
* 在以太网协议中，目的地址分为三种单播地址、广播地址、多播地址，其中单播地址如上面Ａ给Ｂ主机发送，其接收者为一个，并且其目的地址的最高字节的低位为０。

#### 以太网特点

* 无连接。发送方和接收方不建立连接。
* 不可靠。接收方不向发送方进行确认，差错帧直接丢弃。

#### 以太网拓扑结构

跟以太网相关的拓扑结构有星型和总线型。

![星型拓扑结构](<../.gitbook/assets/image (8).png>)



![总线型拓扑结构](<../.gitbook/assets/image (13).png>)

互联网初期，以太网的总线型拓扑比较普遍。随着总线型以太网上的站点数目增多，可靠性也会随之下降，而随着大规模集成电路以及专门芯片的发展,使得星型以太网变得便宜又可靠。

> 需要注意的是，以太网虽然物理上是星型拓扑，但逻辑上是总线型。

### 4. PPP 协议

互联网用户通常需要连接到某个 ISP 之后才能接入到互联网，PPP（点对点）协议是用户计算机和 ISP 进行通信时所使用的数据链路层协议。点对点协议为点对点连接上传输多协议数据包提供了一个标准方法。该协议设计的目的主要是用来通过拨号或专线方式建立点对点连接发送数据，使其成为各种主机、网桥和路由器之间简单连接的一种解决方案。

PPP 协议具有以下特点：

* PPP 协议具有动态分配 IP 地址的能力，其允许在连接时刻协商 IP 地址。
* PPP 支持多种网络协议，例如 TCP/IP、NETBEUI 等。
* PPP 具有差错检测能力，但不具备纠错能力，所以 PPP 是不可靠传输协议。
* 无重传的机制，网络开销小，速度快。
* PPP 具有身份验证的功能

### 5. MAC 地址和 IP 地址

#### **MAC** 地址

数据链路层和物理层使用的地址，是写在**网卡上的物理地址**。MAC 地址用来**定义网络设备的位置**。

* MAC地址长度为6字节，48位；
* MAC地址具有唯一性，每个网络适配器对应一个MAC地址；
* 通常采用十六进制表示法，每个字节表示一个十六进制数，用 - 或 : 连接起来；
* MAC广播地址：FF-FF-FF-FF-FF-FF。

#### **IP** 地址

网络层和以上各层使用的地址，是一种**逻辑地址**。IP 地址用来**区别网络上的计算机**。

#### 可以只有 IP 地址吗

只有当设备连入网络时，才能根据他进入了哪个子网来为其分配 IP 地址，在设备还没有 IP 地址的时候或者在分配 IP 地址的过程中，我们需要 MAC 地址来区分不同的设备。

#### 可以只有 MAC 地址吗

如果我们只使用 MAC 地址进行寻址的话，我们需要路由器记住每个 MAC 地址属于哪一个子网，不然每一次路由器收到数据包时都要满世界寻找目的 MAC 地址。而我们知道 MAC 地址的长度为 48 位，也就是说最多总共有 2 的 48 次方个 MAC 地址，这就意味着每个路由器需要 256 T 的内存，这显然是不现实的。

和 MAC 地址不同，IP 地址是和地域相关的，在一个子网中的设备，我们给其分配的 IP 地址前缀都是一样的，这样路由器就能根据 IP 地址的前缀知道这个设备属于哪个子网，剩下的寻址就交给子网内部实现，从而大大减少了路由器所需要的内存。

光有 MAC 地址的话，寻址困难。IP 地址和地域有关，可以分区域寻址，效率更高。

## 三、物理层

### 1. 物理层作用

作为 OSI 参考模型最低的一层，物理层是整个开放系统的基础，该层利用传输介质为通信的两端建立、管理和释放物理连接，**实现比特流的透明传输**。物理层考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流，其尽可能地屏蔽掉不同种类传输媒体和通信手段的差异，使物理层上面的数据链路层感觉不到这些差异，这样就可以使数据链路层只考虑完成本层的协议和服务，而不必考虑网络的具体传输媒体和通信手段是什么。

### 2. 物理层设备

#### 中继器

Repeater，也叫放大器。同一局域网的再生信号；两端口的网段必须同一协议；5-4-3规程： 10BASE-5以太网中，最多串联4个中继器，5段中只能有3个连接主机。

#### 集线器

同一局域网的再生、放大信号（多端口的中继器）；半双工，不能隔离冲突域也不能隔离广播域。

### 3. 主机间通信方式

#### 单工通信

也叫单向通信，发送方和接收方是固定的，消息只能单向传输。例如采集气象数据、家庭电费，网费等数据收集系统，或者打印机等应用主要采用单工通信。&#x20;

#### 半双工通信

也叫双向交替通信，通信双方都可以发送消息，但同一时刻同一信道只允许单方向发送数据。例如传统的对讲机使用的就是半双工通信。&#x20;

#### 全双工通信

也叫双向同时通信，全双工通信允许通信双方同时在两个方向上传输，其要求通信双方都具有独立的发送和接收数据的能力。例如平时我们打电话，自己说话的同时也能听到对面的声音。

### 4. 通道复用技术

#### 频分复用

（FDM，Frequency Division Multiplexing） 频分复用将传输信道的总带宽按频率划分为若干个子频带或子信道，每个子信道传输一路信号。用户分到一定的频带后，在数据传输的过程中自始至终地占用这个频带。由于每个用户所分到的频带不同，使得传输信道在同一时刻能够支持不同用户进行数据传输，从而实现复用。除了传统意义上的 FDM 外，目前正交频分复用（OFDM）已在高速通信系统中得到广泛应用。

#### 时分复用

（TDM，Time Division Multiplexing） 顾名思义，时分复用将信道传输信息的时间划分为若干个时间片，每一个时分复用的用户在每一个 TDM 帧中占用固定时隙进行数据传输。用户所分配到的时隙是固定的，所以时分复用有时也叫做同步时分复用。这种分配方式能够便于调节控制，但是也存在缺点，当某个信道空闲时，其他繁忙的信道无法占用该空闲信道，因此会降低信道利用率。

#### 波分复用

（WDM，Wavelength Division Multiplexing） 在光通信领域通常按照波长而不是频率来命名，因为光的频率和波长具有单一对应关系，因此 WDM 本质上也是 FDM，光通信系统中，通常由光来运载信号进行传输，WDM 是在一条光纤上传输多个波长光信号，其将 1 根光纤看做多条「虚拟」光纤，每条「虚拟」光纤工作在不同的波长上，从而极大地提高了光纤的传输容量。

#### 码分复用

（CDM，Code Division Multiplexing） 码分复用是靠不同的编码来区分各路原始信号的一种复用方式，不同的用户使用相互正交的码字携带信息。由于码组相互正交，因此接收方能够有效区分不同的用户数据，从而实现每一个用户可以在同样的时间在同样的频带进行数据传输，频谱资源利用率高。其主要和各种多址接入技术相结合从而产生各种接入技术，包括无线和优先接入



