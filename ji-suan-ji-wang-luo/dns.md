---
description: 域名系统（Domain Name System）
---

# DNS

DNS（Domain Name System）是域名系统的英文缩写，是一种组织成域层次结构的计算机和网络服务命名系统，用于 TCP/IP 网络。

其次，DNS 是一个分布式数据库，整个 DNS 系统由分散在世界各地的很多台 DNS 服务器组成，每台 DNS 服务器上都保存了一些数据，这些数据可以让我们最终查到主机名对应的 IP。

## 一、DNS 作用

通常我们有两种方式识别主机：通过主机名或者 IP 地址。人们喜欢便于记忆的主机名表示，而路由器则喜欢定长的、有着层次结构的 IP 地址。为了满足这些不同的偏好，我们就需要一种能够进行主机名到 IP 地址转换的目录服务，域名系统作为将域名和 IP 地址相互映射的一个分布式数据库，能够使人更方便地访问互联网。

> **DNS 的查询过程，就是向 DNS 服务器不断询问的过程，直到查找到跟请求的域名相匹配的 IP 地址。**

## 二、DNS 服务器

![DNS 服务器](<../.gitbook/assets/image (7) (1) (1) (1).png>)



DNS 采用了分布式的设计方案，其域名空间采用一种树形的层次结构，如上图所示。从上到下依次为根域名服务器、顶级域名服务器和权威域名服务器。

* **根 DNS 服务器**

首先我们要明确根域名是什么，比如 `www.baidu.com`，有些同学可能会误以为 `com` 就是根域名，其实 `com` 是顶级域名，`www.baidu.com` 的完整写法是 `www.baidu.com.`，最后的这个 `.` 就是根域名。

根 DNS 服务器的作用就是管理顶级域 DNS 服务器。通过询问根 DNS 服务器，我们可以知道一个主机名对应的顶级域 DNS 服务器的 IP 是多少，从而继续向顶级域 DNS 服务器发起查询请求。

* **顶级域 DNS 服务器**

除了前面提到的 `com` 是顶级域名，常见的顶级域名还有 `cn`、`org`、`edu` 等。顶级域 DNS 服务器，也就是 TLD，提供了它的下一级，也就是权威 DNS 服务器的 IP 地址。

* **权威 DNS 服务器**

权威 DNS 服务器可以返回主机 - IP 的最终映射。

除此之外，还有一类重要的 DNS 服务器，叫做**本地 DNS 服务器**。**本地 DNS 服务器严格来说不在 DNS 服务器的层次结构中**，但它对 DNS 层次结构是很重要的。

一般来说，每个网络服务提供商（ISP） 都有一台本地 DNS 服务器。当主机与某个 ISP 相连时，该 ISP 提供一台主机的 IP 地址，该主机具有一台或多台其本地 DNS 服务器的 IP 地址。主机的本地 DNS 服务器通常和主机距离较近，当主机发起 DNS 请求时，该请求被发送到本地 DNS 服务器，它起着代理的作用，并将该请求转发到 DNS 服务器层次结构中。

## 三、DNS 解析流程

当用户在浏览器里访问一个网站时，域名解析的过程如下：

* **浏览器搜索自身的 DNS 缓存**：

首先浏览器会去搜索自身的 DNS 缓存，看缓存有没有过期，过期的话缓存的解析就结束了（Chrome 缓存的时间只有一分钟，查看 Chrome 的缓存可打开：chrome://net-internals/#dns ）。

* 搜索**操作系统自身的 DNS 缓存**：

如果浏览器没有找到缓存或者缓存过期失效，浏览器就会搜索操作系统自身的缓存，没有找到或者失效，解析结束（操作系统的缓存：window 系统是一天，mac 系统严格根据 DNS 协议中的 TTL）。

* 读取本地的 **Hosts 文件**：

若操作系统的缓存也没有找到或失效，浏览器就会去读取本地的 Hosts 文件（Hosts 文件也可以建立域名到 IP 地址的绑定关系，可以通过编辑 Hosts 文件来达到名称解析的目的。

* 浏览器发起一个 **DNS 的系统调用**：

Hosts 中没有找到对应的配置项的话，浏览器发起一个DNS的调用（向本地主控 DNS 服务，一般来说是你的运营商提供的）。

![DNS 查询过程](<../.gitbook/assets/image (1).png>)

我们以一个例子来了解 DNS 的工作原理，假设主机 A 想知道主机 B （def.mn.edu）的 IP 地址 ，如上图所示，解析的具体过程如下：

* 主机 A 首先向它的本地 DNS 服务器发送一个 DNS 查询报文。该查询报文含有被转换的主机名 def.mn.edu；
* 本地 DNS 服务器将该报文转发到根 DNS 服务器；
* 根 DNS 服务器注意到查询的 IP 地址前缀为 edu 后向本地 DNS 服务器返回负责 edu 的顶级域名服务器的 IP 地址列表；
* 该本地 DNS 服务器则再次向这些顶级域名服务器发送查询报文；
* 该顶级域名服务器注意到 mn.edu 的前缀，并用权威域名服务器的 IP 地址进行响应；
* 通常情况下，顶级域名服务器并不总是知道每台主机的权威 DNS 服务器的 IP 地址，而只知道中间的某个服务器，该中间 DNS 服务器依次能找到用于相应主机的 IP 地址，我们假设中间经历了权威服务器 ① 和 ②，最后找到了负责 def.mn.edu 的权威 DNS 服务器 ③；
* 之后，本地 DNS 服务器直接向该服务器发送查询报文从而获得主机 B 的IP 地址。

在上图中，IP 地址的查询其实经历了两种查询方式，分别是递归查询和迭代查询。

> * **递归查询**：如果主机所询问的本地域名服务器不知道被查询域名的 IP 地址，那么本地域名服务器就以 DNS 客户端的身份，向其他根域名服务器继续发出查询请求报文，即替主机继续查询，而不是让主机自己进行下一步查询，如上图步骤（1）和（10）。&#x20;
> * **迭代查询**：当根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么给出所要查询的 IP 地址，要么告诉本地服务器下一步应该找哪个域名服务器进行查询，然后让本地服务器进行后续的查询，如上图步骤（2）\~（9）。

## 四、DNS 缓存

* 真实互联网中：一台 DNS 服务器可以管理多个域的信息，上下级域共享同一 台 DNS 服务器，访问上级 DNS 服务器时就可以向下跳过一级 DNS 服务器，直接返回再下一级 DNS 服务器的相关信息。
* DNS 服务器有缓存功能：并不需要从根域开始查找，通过缓存可以直接返回响应，接下来的查询可以从缓存的位置开始向下进行。相比每次都从根域找起来说，缓存可以减少查询所需的时间。**有了缓存，大多数 DNS 查询都绕过了根 DNS 服务器**
* 信息被缓存后，原本的注册信息可能会发生改变，这时缓存中的信息就有可能是不正确的，因此缓存信息会设置有效期，当缓存中的信息超过有效期后，数据就会从缓存中删除。

## 五、考点

### 1. 什么是 DNS 劫持

DNS 劫持即域名劫持，是通过**将原域名对应的 IP 地址进行替换**从而使得用户访问到错误的网站或者使得用户无法正常访问网站的一种攻击方式。域名劫持往往只能在特定的网络范围内进行，范围外的 DNS 服务器能够返回正常的 IP 地址。攻击者可以冒充原域名所属机构，通过电子邮件的方式修改组织机构的域名注册信息，或者将域名转让给其它组织，并将新的域名信息保存在所指定的 DNS 服务器中，从而使得用户无法通过对原域名进行解析来访问目的网址。

* 具体**实施步骤**如下：

1. 获取要劫持的域名信息：攻击者首先会访问域名查询站点查询要劫持的域名信息。
2. 控制域名相应的 E-MAIL 账号：在获取到域名信息后，攻击者通过暴力破解或者专门的方法破解公司注册域名时使用的 E-mail 账号所对应的密码。更高级的攻击者甚至能够直接对 E-mail 进行信息窃取。
3. 修改注册信息：当攻击者破解了 E-MAIL 后，会利用相关的更改功能修改该域名的注册信息，包括域名拥有者信息，DNS 服务器信息等。
4. 使用 E-MAIL 收发确认函：在修改完注册信息后，攻击者在 E-mail 真正拥有者之前收到修改域名注册信息的相关确认信息，并回复确认修改文件，待网络公司恢复已成功修改信件后，攻击者便成功完成 DNS 劫持。

* 用户端的一些**预防手段**：

1. 直接通过 IP 地址访问网站，避开 DNS 劫持。&#x20;
2. 通过网络设置让 DNS 指向正常的域名服务器以实现对目的网址的正常访问，例如将计算机首选 DNS 服务器的地址固定为 8.8.8.8。

### 2. DNS 使用 UDP 还是 TCP

**DNS 既使用 TCP 又使用 UDP**。

当进行区域传送（主域名服务器向辅助域名服务器传送变化的那部分数据）时会使用 **TCP**，因为数据同步传送的数据量比一个请求和应答的数据量要多，而 TCP 允许的报文长度更长，因此为了**保证数据的正确性**，会使用基于可靠连接的 TCP。

当客户端向 DNS 服务器查询域名 ( 域名解析) 的时候，一般返回的内容不会超过 UDP 报文的最大长度，即 512 字节。用 **UDP** 传输时，不需要经过 TCP 三次握手的过程，从而大大**提高了响应速度**，但这要求域名解析器和域名服务器都必须自己处理超时和重传从而保证可靠性。

### 3. 查看 DNS 请求过程

可以使用系统自带的 nslookup，也可以使用 dig 工具。

* nslookup 使用：[https://www.jianshu.com/p/8efb3bbc180a](https://www.jianshu.com/p/8efb3bbc180a)
* dig 使用：[http://www.ruanyifeng.com/blog/2016/06/dns.html](http://www.ruanyifeng.com/blog/2016/06/dns.html)

## 六、参考

* [https://zhuanlan.zhihu.com/p/28305778](https://zhuanlan.zhihu.com/p/28305778)
* [https://juejin.cn/post/6990344840181940261](https://juejin.cn/post/6990344840181940261)
* [http://www.ruanyifeng.com/blog/2016/06/dns.html](http://www.ruanyifeng.com/blog/2016/06/dns.html)
