# 流量劫持

## 一、引言

流量劫持主要是针对网络传输过程中的攻击，主要可以分为以下几种：

* CDN 劫持
* DNS 劫持
* HTTP 劫持

## 二、CDN劫持

### 1. CDN 原理

它的名字就叫做`CDN`——**Content Delivery Network**，内容分发网络，`CDN`就是采用更多的缓存服务器（CDN边缘节点），布放在用户访问相对集中的地区或网络中。当用户访问网站时，利用全局负载技术，将用户的访问指向距离最近的缓存服务器上，由缓存服务器响应用户请求。（有点像电商的本地仓吧？）CDN应用广泛，支持多种行业、多种场景内容加速，例如：图片小文件、大文件下载、视音频点播、直播流媒体、全站加速、安全加速。

### 2. CDN 劫持

网络上有很多黑客为了让用户能够登录自己开发的钓鱼网站，都会通过对 CDN 进行劫持的方法，让用户自动转入自己开发的网站。而很多用户却往往无法察觉到自己已经被劫持。其实验证被劫持的方法，就是输入任何网址看看所打开的网页是否和自己输入的网址一致，

### 3. 防范措施

#### **3.1 使用 SRI**

**SRI** 全称 Subresource Integrity - 子资源完整性，是指浏览器通过验证资源的完整性（通常从 CDN 获取）来判断其是否被篡改的安全特性。

通过给 link 标签或者 script 标签增加 integrity 属性即可开启 SRI 功能，比如

```html
<script type="text/javascript" src="//s.url.cn/xxxx/aaa.js" 
    integrity="sha256-xxx sha384-yyy"
    crossorigin="anonymous"></script>
```

integrity 值分成两个部分，第一部分指定哈希值的生成算法（sha256、sha384 及 sha512），第二部分是经过 base64 编码的实际哈希值，两者之间通过一个短横（-）分割。integrity 值可以包含多个由空格分隔的哈希值，只要文件匹配其中任意一个哈希值，就可以通过校验并加载该资源。**开启 SRI 能有效保证页面引用资源的完整性，避免恶意代码执行。**

> **浏览器如何处理 SRI**
>
> * 当浏览器在 script 或者 link 标签中遇到 integrity 属性之后，会在执行脚本或者应用样式表之前对比所加载文件的哈希值和期望的哈希值。
> * 当脚本或者样式表的哈希值和期望的不一致时，浏览器必须拒绝执行脚本或者应用样式表，并且必须返回一个网络错误说明获得脚本或样式表失败。

## 三、DNS 劫持

### 1. 攻击原理

DNS 劫持又称域名劫持，是指在劫持的网络范围内拦截域名解析的请求，分析请求的域名，把审查范围以外的请求放行，否则返回假的 IP 地址或者什么都不做使请求失去响应，其效果就是对特定的网络不能访问或访问的是假网址。其实本质就是破坏正常的 DNS 解析过程。

### 2. 攻击方法

#### **2.1 本机 DNS 劫持**

攻击者通过某些手段使用户的计算机感染上木马病毒，或者恶意软件之后，恶意修改本地 DNS 配置，比如修改本地 hosts 文件，缓存等

#### **2.2 路由 DNS 劫持**

很多用户默认路由器的默认密码，攻击者可以侵入到路由管理员账号中，修改路由器的默认配置

#### **2.3 攻击 DNS 服务器**

直接攻击 DNS 服务器，例如对 DNS 服务器进行 DDOS 攻击，可以使 DNS 服务器宕机，出现异常请求，还可以利用某些手段感染 dns 服务器的缓存，使给用户返回来的是恶意的 ip 地址

攻击过程大致如下：

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2017/9/14/eadef534e6c4347b6e2e6feb91e97b89\~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp)

### **3. 防范措施**

**3.1 加强本地计算机病毒检查，开启防火墙等，防止恶意软件，木马病毒感染计算机**

**3.2 改变路由器默认密码，防止攻击者修改路由器的DNS配置指向恶意的DNS服务器**

**3.3 企业的话可以准备两个以上的域名，一旦一个域名挂掉，还可以使用另一个**

> 对于DNS劫持，往往单靠个人设置很难解决，如果已经出现了劫持现象的话，对电脑进去杀毒，清理，检查hosts文件，核查网络设置的DNS配置（可以使用写公共的DNS服务器）

## 四、HTTP 劫持

### 1. 攻击原理

大家都知道，HTTP 请求是明文的。而 HTTP 劫持主要是篡改请求的内容。例如：你打开一个网页，请求返回一个 HTML 文件，然后有意者修改这个 HTML，往里面插了个小广告，然后再返回给你。广告还算小事，要是返回一个表单让你输入账号密码呢？你全然不知，还以为这是原来网站上的表单。

### 2. 防御措施

#### 2.1 HSTS <a href="#hsts" id="hsts"></a>

`HSTS` 的全称是 `HTTP` `Strict-Transport-Security`（严格传输安全），它是一个 `Web` 安全策略机制，通过服务器设置 `HTTP Response Header` 告诉浏览器只能通过 `HTTPS` 访问当前资源，而不是 `HTTP`。

HSTS 语法如下：

```
Strict-Transport-Security: <max-age=>[; includeSubDomains][; preload]
```

* `max-age` 是必选参数，是一个以秒为单位的数值，它代表着 `HSTS Header` 的过期时间，通常设置为 1 年，即 31536000 秒。
* `includeSubDomains` 是可选参数，如果包含它，则意味着当前域名及其子域名均开启 `HSTS` 保护。
* `preload` 是可选参数，只有当你申请将自己的域名加入到浏览器内置列表的时候才需要使用到它

HSTS 更多：

* 只要是在有效期内，浏览器都将直接强制性的发起 `HTTPS` 请求。
* `HSTS` 让浏览器强制拒绝不安全的链接，不给用户选择的机会。
* 第一次访问网站的时候，依然需要一次明文的 `HTTP` 请求和重定向才能切换到 `HTTPS`，以及刷新 `HSTS` 信息，此时仍然可以进行中间人攻击，对此，浏览器里内置一个列表 `Preload List`，只要是在这个列表里的域名，无论何时、何种情况，浏览器都只使用 `HTTPS` 发起连接。

#### 2.2 cookie secure

通过 `cookie` `secure` 保证你的 `session cookie` 对于攻击者是不可见的，避免中间人攻击。

## 五、参考

* [浏览器安全](https://juejin.cn/post/6892961914079412237)
* [你需要知道的“DNS劫持”](https://juejin.cn/post/6844903863623876622)
